<template>
  <Teleport to="body">
    <div
      v-if="visible"
      class="fixed inset-0 z-50 flex items-center justify-end"
    >
      <!-- 遮罩层 -->
      <div 
        class="fixed inset-0 bg-black/50"
        @click="handleClose"
      ></div>
      
      <!-- 编辑漏洞面板 - 有滑入动画 -->
      <Transition name="slide">
        <div
          v-if="showPanel"
          class="relative w-[70vw] h-full bg-panel-dark shadow-2xl flex flex-col overflow-hidden"
          @click.stop
        >
          <!-- 头部 -->
          <div class="sticky top-0 z-20 bg-panel-dark/80 backdrop-blur-sm border-b border-border-dark">
            <div class="flex items-center justify-between px-6 py-4">
              <h2 class="text-xl font-bold text-white">{{ $t('vulnerabilities.edit.title') || '编辑漏洞' }}</h2>
              <button
                @click="handleClose"
                class="p-2 text-text-light hover:text-white transition-colors"
              >
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>
          </div>

          <!-- 内容区 -->
          <div class="flex-1 p-6 overflow-y-auto custom-scrollbar">
            <form @submit.prevent="handleSubmit" class="space-y-6">
              <!-- 漏洞标题 - 独占一行 -->
              <div>
                <label class="block text-sm font-medium text-white mb-2">
                  {{ $t('vulnerabilities.detail.title') || '标题' }} <span class="text-red-400">*</span>
                </label>
                <input
                  v-model="formData.title"
                  type="text"
                  required
                  class="w-full bg-[#1e293b] text-white border border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
                  :placeholder="$t('vulnerabilities.edit.titlePlaceholder') || '请输入漏洞标题'"
                />
              </div>

              <!-- 第一行：状态和风险等级 -->
              <div class="grid grid-cols-2 gap-4">
                <!-- 当前状态 -->
                <div>
                  <label class="block text-sm font-medium text-white mb-2">
                    {{ $t('vulnerabilities.detail.statusLabel') || '状态' }} <span class="text-red-400">*</span>
                  </label>
                  <select
                    v-model="formData.status"
                    required
                    class="w-full bg-[#1e293b] text-white border border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors appearance-none cursor-pointer"
                  >
                    <option value="Open">{{ $t('vulnerabilities.detail.status.open') || 'Open' }}</option>
                    <option value="Block">{{ $t('vulnerabilities.detail.status.inProgress') || 'In Progress' }}</option>
                    <option value="Closed">{{ $t('vulnerabilities.detail.status.patched') || 'Patched' }}</option>
                  </select>
                </div>

                <!-- 风险等级 -->
                <div>
                  <label class="block text-sm font-medium text-white mb-2">
                    {{ $t('vulnerabilities.detail.riskLevel') || '风险等级' }} <span class="text-red-400">*</span>
                  </label>
                  <select
                    v-model="formData.severity"
                    required
                    class="w-full bg-[#1e293b] text-white border border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors appearance-none cursor-pointer"
                  >
                    <option value="">{{ $t('vulnerabilities.edit.selectSeverity') || '请选择风险等级' }}</option>
                    <option value="Critical">{{ severityToNumber('Critical') }}</option>
                    <option value="High">{{ severityToNumber('High') }}</option>
                    <option value="Medium">{{ severityToNumber('Medium') }}</option>
                    <option value="Low">{{ severityToNumber('Low') }}</option>
                    <option value="Tips">{{ severityToNumber('Tips') }}</option>
                  </select>
                </div>
              </div>

              <!-- 第二行：责任人和调查员 -->
              <div class="grid grid-cols-2 gap-4">
                <!-- 责任人 -->
                <div>
                  <label class="block text-sm font-medium text-white mb-2">
                    {{ $t('vulnerabilities.detail.responsiblePerson') || '责任人' }}
                  </label>
                  <input
                    v-model="formData.owner"
                    type="text"
                    class="w-full bg-[#1e293b] text-white border border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
                    :placeholder="$t('vulnerabilities.edit.ownerPlaceholder') || '请输入责任人'"
                  />
                </div>

                <!-- 调查员 -->
                <div>
                  <label class="block text-sm font-medium text-white mb-2">
                    {{ $t('incidents.detail.actor') || '调查员' }}
                  </label>
                  <input
                    v-model="formData.actor"
                    type="text"
                    class="w-full bg-[#1e293b] text-white border border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
                    :placeholder="$t('incidents.detail.actor') || '请输入调查员'"
                  />
                </div>
              </div>

              <!-- 责任部门 -->
              <div>
                <label class="block text-sm font-medium text-white mb-2">
                  {{ $t('vulnerabilities.detail.responsibleDepartment') || '责任部门' }}
                </label>
                <input
                  v-model="formData.responsibleDepartment"
                  type="text"
                  class="w-full bg-[#1e293b] text-white border border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
                  :placeholder="$t('vulnerabilities.edit.departmentPlaceholder') || '请输入责任部门'"
                />
              </div>

              <!-- 漏洞描述 - 独占一行 -->
              <div>
                <label class="block text-sm font-medium text-white mb-2">
                  {{ $t('vulnerabilities.detail.description') || '描述' }} <span class="text-red-400">*</span>
                </label>
                <textarea
                  v-model="formData.description"
                  rows="6"
                  required
                  class="w-full bg-[#1e293b] text-white border border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none resize-none transition-colors"
                  :placeholder="$t('vulnerabilities.edit.descriptionPlaceholder') || '请输入漏洞描述'"
                ></textarea>
              </div>

              <!-- 按钮组 -->
              <div class="flex items-center justify-end gap-4 pt-4 border-t border-border-dark">
                <button
                  type="button"
                  @click="handleClose"
                  class="px-6 py-2 text-sm font-medium text-white bg-[#2a3546] rounded-md hover:bg-[#3c4a60] transition-colors"
                >
                  {{ $t('common.cancel') }}
                </button>
                <button
                  type="submit"
                  :disabled="isSubmitting"
                  class="px-6 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                >
                  <span v-if="isSubmitting" class="material-symbols-outlined animate-spin text-base">sync</span>
                  {{ $t('common.submit') }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </Transition>
    </div>
  </Teleport>
</template>

<script setup>
import { ref, watch, onMounted, onUnmounted } from 'vue'
import { useI18n } from 'vue-i18n'
import axios from 'axios'
import { useAuthStore } from '@/stores/auth'
import { useToast } from '@/composables/useToast'
import { severityToNumber } from '@/utils/severity'

const props = defineProps({
  visible: {
    type: Boolean,
    default: false
  },
  vulnerabilityId: {
    type: [Number, String],
    required: true
  },
  initialData: {
    type: Object,
    default: null
  }
})

const emit = defineEmits(['close', 'updated'])

const { t } = useI18n()
const toast = useToast()
const authStore = useAuthStore()

const showPanel = ref(false)
const isSubmitting = ref(false)

// 初始化表单数据
const getInitialFormData = () => {
  return {
    title: '',
    status: 'Open',
    severity: '',
    owner: '',
    responsibleDepartment: '',
    actor: '',
    description: ''
  }
}

const formData = ref(getInitialFormData())

// 填充表单数据的函数
const fillFormData = () => {
  formData.value = getInitialFormData()
  
  if (props.initialData) {
    formData.value.title = props.initialData.title || ''
    formData.value.status = props.initialData.status || 'Open'
    formData.value.severity = props.initialData.severity || ''
    formData.value.owner = props.initialData.owner || ''
    formData.value.responsibleDepartment = props.initialData.responsibleDepartment || ''
    formData.value.actor = props.initialData.actor || ''
    formData.value.description = props.initialData.description || ''
  } else {
    console.warn('No initial data provided to EditVulnerabilityDialog')
  }
}

// 监听 visible 变化，控制动画和表单填充
watch(() => props.visible, (newVal) => {
  if (newVal) {
    fillFormData()
    setTimeout(() => {
      showPanel.value = true
    }, 10)
  } else {
    showPanel.value = false
  }
})

// 同时监听 initialData 变化
watch(() => props.initialData, (newData) => {
  if (props.visible && newData) {
    fillFormData()
  }
}, { deep: true })

const handleClose = () => {
  showPanel.value = false
  setTimeout(() => {
    emit('close')
  }, 300)
}

const handleSubmit = async () => {
  if (isSubmitting.value) return

  try {
    isSubmitting.value = true
    
    // 构建符合 /api/vulnerabilities 接口格式的请求体，与创建事件类似
    const body = {
      action: 'update',
      title: formData.value.title,
      description: formData.value.description || '',
      severity: formData.value.severity || '',
      actor: formData.value.actor || '',
      resource_list: [{
        owner: formData.value.owner || '',
        responsible_person: formData.value.owner || '',
        responsible_dept: formData.value.responsibleDepartment || '',
        category: '' // 漏洞可能不需要category，但保持格式一致
      }]
    }

    const apiBaseURL = import.meta.env.VITE_API_BASE_URL || ''
    const url = apiBaseURL ? `${apiBaseURL}/vulnerabilities/${props.vulnerabilityId}` : `/api/vulnerabilities/${props.vulnerabilityId}`
    
    const headers = {
      'Content-Type': 'application/json'
    }
    if (authStore.token) {
      headers['Authorization'] = `Bearer ${authStore.token}`
    }
    
    await axios.put(url, body, { headers })
    
    toast.success(t('vulnerabilities.edit.success') || '漏洞更新成功', '操作成功')
    
    emit('updated')
    handleClose()
  } catch (error) {
    console.error('Failed to update vulnerability:', error)
    const errorMessage = error?.response?.data?.message || error?.message || t('vulnerabilities.edit.error') || '漏洞更新失败，请稍后重试'
    toast.error(errorMessage, '操作失败')
  } finally {
    isSubmitting.value = false
  }
}

// 监听 visible 变化，控制 body 滚动
watch(() => props.visible, (newVal) => {
  if (newVal) {
    document.body.style.overflow = 'hidden'
  } else {
    document.body.style.overflow = ''
  }
}, { immediate: true })

onMounted(() => {
  if (props.visible) {
    setTimeout(() => {
      showPanel.value = true
    }, 10)
  }
})

onUnmounted(() => {
  document.body.style.overflow = ''
})
</script>

<style scoped>
.slide-enter-active,
.slide-leave-active {
  transition: transform 0.3s ease-in-out;
}

.slide-enter-from {
  transform: translateX(100%);
}

.slide-leave-to {
  transform: translateX(100%);
}

/* 自定义滚动条样式 */
.custom-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
}

.custom-scrollbar::-webkit-scrollbar {
  width: 4px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background-color: rgba(59, 130, 246, 0.3);
  border-radius: 2px;
  transition: background-color 0.2s ease;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background-color: rgba(59, 130, 246, 0.5);
}

/* 美化 select 下拉框 */
select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 1.25rem;
  padding-right: 2.75rem !important;
}

select:focus {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%232b7cee' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
}

select option {
  background-color: #1e293b;
  color: white;
  padding: 0.5rem;
}

input:hover:not(:focus),
select:hover:not(:focus),
textarea:hover:not(:focus) {
  border-color: #3c4a60;
}

input:focus,
select:focus,
textarea:focus {
  border-color: #2b7cee;
  box-shadow: 0 0 0 3px rgba(43, 124, 238, 0.1);
}
</style>


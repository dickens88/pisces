<template>
  <Teleport to="body">
    <div
      v-if="visible"
      class="fixed inset-0 z-50 flex items-center justify-end"
    >
      <!-- 遮罩层 -->
      <div 
        class="fixed inset-0 bg-black/50"
        @click="handleClose"
      ></div>
      
      <!-- 创建漏洞面板 - 有滑入动画 -->
      <Transition name="slide">
        <div
          v-if="showPanel"
          class="relative w-[70vw] h-full bg-white dark:bg-panel-dark shadow-2xl flex flex-col overflow-hidden"
          @click.stop
        >
          <!-- 头部 -->
          <div class="sticky top-0 z-20 bg-white/90 dark:bg-panel-dark/80 backdrop-blur-sm border-b border-gray-200 dark:border-border-dark">
            <div class="flex items-center justify-between px-6 py-4">
              <h2 class="text-xl font-bold text-gray-900 dark:text-white">{{ $t('vulnerabilities.create.title') || '创建漏洞' }}</h2>
              <button
                @click="handleClose"
                class="p-2 text-gray-500 dark:text-text-light hover:text-gray-900 dark:hover:text-white transition-colors"
              >
                <span class="material-symbols-outlined">close</span>
              </button>
            </div>
          </div>

          <!-- 内容区 -->
          <div class="flex-1 p-6 overflow-y-auto custom-scrollbar bg-gray-50 dark:bg-transparent">
            <form @submit.prevent="handleSubmit" class="space-y-6">
              <!-- 漏洞标题 - 独占一行 -->
              <div>
                <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
                  {{ $t('vulnerabilities.detail.title') || '标题' }} <span class="text-red-400">*</span>
                </label>
                <input
                  v-model="formData.title"
                  type="text"
                  required
                  class="w-full bg-white dark:bg-[#1e293b] text-gray-900 dark:text-white border border-gray-300 dark:border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
                  :placeholder="$t('vulnerabilities.edit.titlePlaceholder') || '请输入漏洞标题'"
                />
              </div>

              <!-- 第一行：状态和风险等级 -->
              <div class="grid grid-cols-2 gap-4">
                <!-- 当前状态 -->
                <div>
                  <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
                    {{ $t('vulnerabilities.detail.statusLabel') || '状态' }} <span class="text-red-400">*</span>
                  </label>
                  <select
                    v-model="formData.status"
                    required
                    class="w-full bg-white dark:bg-[#1e293b] text-gray-900 dark:text-white border border-gray-300 dark:border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors appearance-none cursor-pointer"
                  >
                    <option value="Open">{{ $t('vulnerabilities.detail.status.open') || 'Open' }}</option>
                    <option value="Block">{{ $t('vulnerabilities.detail.status.inProgress') || 'In Progress' }}</option>
                    <option value="Closed">{{ $t('vulnerabilities.detail.status.patched') || 'Patched' }}</option>
                  </select>
                </div>

                <!-- 风险等级 -->
                <div>
                  <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
                    {{ $t('vulnerabilities.detail.riskLevel') || '风险等级' }} <span class="text-red-400">*</span>
                  </label>
                  <select
                    v-model="formData.severity"
                    required
                    class="w-full bg-white dark:bg-[#1e293b] text-gray-900 dark:text-white border border-gray-300 dark:border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors appearance-none cursor-pointer"
                  >
                    <option value="">{{ $t('vulnerabilities.edit.selectSeverity') || '请选择风险等级' }}</option>
                    <option value="Critical">{{ severityToNumber('Critical') }}</option>
                    <option value="High">{{ severityToNumber('High') }}</option>
                    <option value="Medium">{{ severityToNumber('Medium') }}</option>
                    <option value="Low">{{ severityToNumber('Low') }}</option>
                    <option value="Tips">{{ severityToNumber('Tips') }}</option>
                  </select>
                </div>
              </div>

              <!-- 第二行：责任人和调查员 -->
              <div class="grid grid-cols-2 gap-4">
                <!-- 责任人 -->
                <div>
                  <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
                    {{ $t('vulnerabilities.detail.responsiblePerson') || '责任人' }}
                  </label>
                  <input
                    v-model="formData.owner"
                    type="text"
                    class="w-full bg-white dark:bg-[#1e293b] text-gray-900 dark:text-white border border-gray-300 dark:border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
                    :placeholder="$t('vulnerabilities.edit.ownerPlaceholder') || '请输入责任人'"
                  />
                </div>

                <!-- 调查员 -->
                <div>
                  <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
                    {{ $t('incidents.detail.actor') || '调查员' }}
                  </label>
                  <input
                    v-model="formData.actor"
                    type="text"
                    class="w-full bg-white dark:bg-[#1e293b] text-gray-900 dark:text-white border border-gray-300 dark:border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
                    :placeholder="$t('incidents.detail.actor') || '请输入调查员'"
                  />
                </div>
              </div>

              <!-- 责任部门 -->
              <div>
                <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
                  {{ $t('vulnerabilities.detail.responsibleDepartment') || '责任部门' }}
                </label>
                <input
                  v-model="formData.responsibleDepartment"
                  type="text"
                  class="w-full bg-white dark:bg-[#1e293b] text-gray-900 dark:text-white border border-gray-300 dark:border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
                  :placeholder="$t('vulnerabilities.edit.departmentPlaceholder') || '请输入责任部门'"
                />
              </div>

              <!-- 漏洞描述 - 独占一行 -->
              <div>
                <label class="block text-sm font-medium text-gray-900 dark:text-white mb-2">
                  {{ $t('vulnerabilities.detail.description') || '描述' }} <span class="text-red-400">*</span>
                </label>
                <textarea
                  v-model="formData.description"
                  rows="6"
                  required
                  class="w-full bg-white dark:bg-[#1e293b] text-gray-900 dark:text-white border border-gray-300 dark:border-[#324867] rounded-md px-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary outline-none resize-none transition-colors"
                  :placeholder="$t('vulnerabilities.edit.descriptionPlaceholder') || '请输入漏洞描述'"
                ></textarea>
              </div>

              <!-- 按钮组 -->
              <div class="flex items-center justify-end gap-4 pt-4 border-t border-gray-200 dark:border-border-dark">
                <button
                  type="button"
                  @click="handleClose"
                  class="px-6 py-2 text-sm font-medium text-gray-700 dark:text-white bg-gray-100 dark:bg-[#2a3546] border border-gray-200 dark:border-transparent rounded-md hover:bg-gray-200 dark:hover:bg-[#3c4a60] transition-colors"
                >
                  {{ $t('common.cancel') }}
                </button>
                <button
                  type="submit"
                  :disabled="isSubmitting"
                  class="px-6 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                >
                  <span v-if="isSubmitting" class="material-symbols-outlined animate-spin text-base">sync</span>
                  {{ $t('common.submit') }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </Transition>
    </div>
  </Teleport>
</template>

<script setup>
import { ref, watch, onMounted, onUnmounted } from 'vue'
import { useI18n } from 'vue-i18n'
import axios from 'axios'
import { useAuthStore } from '@/stores/auth'
import { useToast } from '@/composables/useToast'
import { severityToNumber } from '@/utils/severity'

const props = defineProps({
  visible: {
    type: Boolean,
    default: false
  },
  initialData: {
    type: Object,
    default: null
  },
  alertIds: {
    type: Array,
    default: () => []
  }
})

const emit = defineEmits(['close', 'created'])

const { t } = useI18n()
const toast = useToast()
const authStore = useAuthStore()

const showPanel = ref(false)
const isSubmitting = ref(false)

// 初始化表单数据
const getInitialFormData = () => {
  const initial = props.initialData || {}
  
  // 转换告警的 riskLevel 到漏洞的 severity
  let severity = ''
  if (initial.riskLevel) {
    // 将小写的 riskLevel (fatal/high/medium/low/tips) 转换为首字母大写的 Severity (Fatal/High/Medium/Low/Tips)
    severity = initial.riskLevel.charAt(0).toUpperCase() + initial.riskLevel.slice(1)
  } else if (initial.severity) {
    severity = initial.severity
  }
  
  // 转换告警的 status 到漏洞的 status
  let status = 'Open'
  if (initial.status) {
    // 将小写的 status (open/block/closed) 转换为首字母大写的 Status (Open/Block/Closed)
    status = initial.status.charAt(0).toUpperCase() + initial.status.slice(1)
  } else if (initial.handle_status) {
    status = initial.handle_status
  }
  
  // 处理描述：如果是对象，转换为字符串
  let description = ''
  if (initial.description) {
    if (typeof initial.description === 'object' && initial.description !== null) {
      description = JSON.stringify(initial.description, null, 2)
    } else {
      description = String(initial.description)
    }
  }
  
  return {
    title: initial.title || '',
    status: status,
    severity: severity,
    owner: initial.owner || '',
    responsibleDepartment: initial.responsibleDepartment || '',
    actor: initial.actor || '',
    description: description
  }
}

const formData = ref(getInitialFormData())

// 监听 visible 和 initialData 变化，控制动画和表单重置
watch([() => props.visible, () => props.initialData], ([newVal, newInitialData]) => {
  if (newVal) {
    // 使用最新的 initialData 重置表单
    formData.value = getInitialFormData()
    setTimeout(() => {
      showPanel.value = true
    }, 10)
  } else {
    showPanel.value = false
  }
}, { deep: true })

const handleClose = () => {
  showPanel.value = false
  setTimeout(() => {
    emit('close')
  }, 300)
}

const handleSubmit = async () => {
  if (isSubmitting.value) return

  try {
    isSubmitting.value = true
    
    // 如果有告警ID，说明是转事件操作，使用 convert action；否则是创建事件，使用 create action
    const action = (props.alertIds && props.alertIds.length > 0) ? 'convert' : 'create'
    
    // 构建符合 /api/incidents 接口格式的请求体，添加 search_vulscan=true
    const body = {
      action: action,
      title: formData.value.title,
      description: formData.value.description || '',
      severity: formData.value.severity || '',
      actor: formData.value.actor || '',
      search_vulscan: true,
      resource_list: [{
        owner: formData.value.owner || '',
        responsible_person: formData.value.owner || '',
        responsible_dept: formData.value.responsibleDepartment || '',
        category: '' // 漏洞可能不需要category，但保持格式一致
      }]
    }
    
    // 如果有告警ID，添加到请求体中
    if (props.alertIds && props.alertIds.length > 0) {
      body.ids = props.alertIds
    }

    const apiBaseURL = import.meta.env.VITE_API_BASE_URL || ''
    const url = apiBaseURL ? `${apiBaseURL}/incidents` : '/api/incidents'
    
    const headers = {
      'Content-Type': 'application/json'
    }
    if (authStore.token) {
      headers['Authorization'] = `Bearer ${authStore.token}`
    }
    
    await axios.post(url, body, { headers })
    
    toast.success(t('vulnerabilities.create.success') || '漏洞创建成功', 'SUCCESS')
    
    emit('created')
    handleClose()
  } catch (error) {
    console.error('Failed to create vulnerability:', error)
    const errorMessage = error?.response?.data?.message || error?.message || t('vulnerabilities.create.error') || '漏洞创建失败，请稍后重试'
    toast.error(errorMessage, '操作失败')
  } finally {
    isSubmitting.value = false
  }
}

// 监听 visible 变化，控制 body 滚动
watch(() => props.visible, (newVal) => {
  if (newVal) {
    document.body.style.overflow = 'hidden'
  } else {
    document.body.style.overflow = ''
  }
}, { immediate: true })

onMounted(() => {
  if (props.visible) {
    setTimeout(() => {
      showPanel.value = true
    }, 10)
  }
})

onUnmounted(() => {
  document.body.style.overflow = ''
})
</script>

<style scoped>
.slide-enter-active,
.slide-leave-active {
  transition: transform 0.3s ease-in-out;
}

.slide-enter-from {
  transform: translateX(100%);
}

.slide-leave-to {
  transform: translateX(100%);
}

/* 自定义滚动条样式 */
.custom-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: rgba(59, 130, 246, 0.3) transparent;
}

.custom-scrollbar::-webkit-scrollbar {
  width: 4px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background-color: rgba(59, 130, 246, 0.3);
  border-radius: 2px;
  transition: background-color 0.2s ease;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background-color: rgba(59, 130, 246, 0.5);
}

/* 美化 select 下拉框 */
select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 1.25rem;
  padding-right: 2.75rem !important;
}

select:focus {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%232b7cee' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
}

select option {
  background-color: #ffffff;
  color: #111827;
  padding: 0.5rem;
}

.dark select option {
  background-color: #1e293b;
  color: white;
}

input:hover:not(:focus),
select:hover:not(:focus),
textarea:hover:not(:focus) {
  border-color: #9ca3af;
}

.dark input:hover:not(:focus),
.dark select:hover:not(:focus),
.dark textarea:hover:not(:focus) {
  border-color: #3c4a60;
}

input:focus,
select:focus,
textarea:focus {
  border-color: #2b7cee;
  box-shadow: 0 0 0 3px rgba(43, 124, 238, 0.1);
}
</style>


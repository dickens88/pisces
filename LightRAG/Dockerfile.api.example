# syntax=docker/dockerfile:1

# -------------------------------------
# Python build stage - using uv
# -------------------------------------
    FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim AS builder

    ENV DEBIAN_FRONTEND=noninteractive
    ENV UV_SYSTEM_PYTHON=1
    ENV UV_COMPILE_BYTECODE=1
    
    WORKDIR /app
    
    # Install system deps (Rust is required by some wheels)
    RUN apt-get update \
        && apt-get install -y --no-install-recommends \
            curl \
            build-essential \
            pkg-config \
        && rm -rf /var/lib/apt/lists/* \
        && curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    
    ENV PATH="/root/.cargo/bin:/root/.local/bin:${PATH}"
    
    RUN mkdir -p /root/.local/share/uv
    
    # Copy project metadata
    COPY pyproject.toml .
    COPY setup.py .
    COPY uv.lock .
    
    # Install dependencies (api only)
    RUN --mount=type=cache,target=/root/.local/share/uv \
        uv sync --frozen --no-dev --extra api --no-install-project --no-editable
    
    # Copy Python project source
    COPY lightrag ./lightrag
    
    # create empty index.html
    RUN mkdir -p /app/lightrag/api/webui \
        && echo "<html></html>" > /app/lightrag/api/webui/index.html
    
    # Second sync (install project package)
    RUN --mount=type=cache,target=/root/.local/share/uv \
        uv sync --frozen --no-dev --extra api --no-editable \
        && /app/.venv/bin/python -m ensurepip --upgrade
    
    # Pre-populate tokenizer cache
    RUN mkdir -p /app/data/tiktoken \
        && uv run lightrag-download-cache --cache-dir /app/data/tiktoken || status=$?; \
        if [ -n "${status:-}" ] && [ "$status" -ne 0 ] && [ "$status" -ne 2 ]; then exit "$status"; fi
    
    
    # -------------------------------------
    # Final Runtime Stage
    # -------------------------------------
    FROM python:3.12-slim
    
    WORKDIR /app
    
    COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv
    
    ENV UV_SYSTEM_PYTHON=1
    
    # Copy dependencies + venv + code
    COPY --from=builder /root/.local /root/.local
    COPY --from=builder /app/.venv /app/.venv
    COPY --from=builder /app/lightrag ./lightrag
    COPY pyproject.toml .
    COPY setup.py .
    COPY uv.lock .
    
    # PATH for venv
    ENV PATH=/app/.venv/bin:/root/.local/bin:$PATH
    
    # API-only sync
    RUN --mount=type=cache,target=/root/.local/share/uv \
        uv sync --frozen --no-dev --extra api --no-editable \
        && /app/.venv/bin/python -m ensurepip --upgrade
    
    # Persistent data dirs
    RUN mkdir -p /app/data/rag_storage /app/data/inputs /app/data/tiktoken
    
    COPY --from=builder /app/data/tiktoken /app/data/tiktoken
    
    # Disable WebUI
    ENV LIGHTRAG_DISABLE_WEBUI=1
    
    # Env variables
    ENV TIKTOKEN_CACHE_DIR=/app/data/tiktoken
    ENV WORKING_DIR=/app/data/rag_storage
    ENV INPUT_DIR=/app/data/inputs
    
    EXPOSE 9621
    
    ENTRYPOINT ["python", "-m", "lightrag.api.lightrag_server"]
    
    
"""
漏洞相关的Mock API视图
实现前端vulnerabilities.js中的所有mock接口
"""
import json
from flask import request
from flask_restful import Resource
from data.mock_data import MOCK_VULNERABILITIES
from utils.logger_init import logger

# 使用列表副本以便修改
mock_vulnerabilities = [vuln.copy() for vuln in MOCK_VULNERABILITIES]


class MockVulnerabilityListView(Resource):
    """获取漏洞列表"""
    
    def get(self):
        try:
            params = request.args.to_dict()
            search = params.get('search', '')
            risk_level = params.get('riskLevel', 'all')
            status = params.get('status', 'all')
            page = int(params.get('page', 1))
            page_size = int(params.get('pageSize', 10))
            
            filtered_vulnerabilities = [vuln.copy() for vuln in mock_vulnerabilities]
            
            # 搜索过滤
            if search:
                search_lower = search.lower()
                filtered_vulnerabilities = [
                    vuln for vuln in filtered_vulnerabilities
                    if search_lower in vuln['name'].lower() or
                    search_lower in vuln['cve'].lower() or
                    search_lower in vuln['affectedAsset'].lower()
                ]
            
            # 风险等级过滤
            if risk_level and risk_level != 'all':
                filtered_vulnerabilities = [
                    vuln for vuln in filtered_vulnerabilities
                    if vuln['riskLevel'] == risk_level
                ]
            
            # 状态过滤
            if status and status != 'all':
                filtered_vulnerabilities = [
                    vuln for vuln in filtered_vulnerabilities
                    if vuln['status'] == status
                ]
            
            # 分页
            total = len(filtered_vulnerabilities)
            start = (page - 1) * page_size
            end = start + page_size
            paginated_data = filtered_vulnerabilities[start:end]
            
            return {
                "data": paginated_data,
                "total": total,
                "page": page,
                "pageSize": page_size
            }, 200
        except Exception as ex:
            logger.exception(ex)
            return {"error_message": str(ex)}, 500


class MockVulnerabilityDetailView(Resource):
    """获取漏洞详情"""
    
    def get(self, vulnerability_id):
        try:
            vulnerability = next((v for v in mock_vulnerabilities if v['id'] == int(vulnerability_id)), None)
            if vulnerability:
                return {
                    "data": {
                        **vulnerability,
                        "description": "这是一个详细的漏洞描述信息，包含了漏洞的详细信息、影响范围、修复建议等。",
                        "cvss": "9.8",
                        "affectedSystems": ["Windows Server 2019", "Windows Server 2022"],
                        "remediation": "建议立即更新到最新版本或应用安全补丁。",
                        "references": [
                            f"https://cve.mitre.org/cgi-bin/cvename.cgi?name={vulnerability['cve']}"
                        ]
                    }
                }, 200
            else:
                return {"error_message": "Vulnerability not found"}, 404
        except Exception as ex:
            logger.exception(ex)
            return {"error_message": str(ex)}, 500


class MockVulnerabilityTrendView(Resource):
    """获取漏洞趋势统计"""
    
    def get(self):
        try:
            # 模拟6个月的数据
            trend_data = [
                {"month": "7月", "critical": 25, "high": 40, "medium": 20, "low": 10},
                {"month": "8月", "critical": 30, "high": 35, "medium": 15, "low": 5},
                {"month": "9月", "critical": 15, "high": 25, "medium": 35, "low": 20},
                {"month": "10月", "critical": 35, "high": 45, "medium": 15, "low": 5},
                {"month": "11月", "critical": 20, "high": 30, "medium": 25, "low": 15},
                {"month": "12月", "critical": 25, "high": 50, "medium": 15, "low": 10}
            ]
            
            return {"data": trend_data}, 200
        except Exception as ex:
            logger.exception(ex)
            return {"error_message": str(ex)}, 500


class MockVulnerabilityDepartmentDistributionView(Resource):
    """获取漏洞责任部门分布"""
    
    def get(self):
        try:
            # 模拟5个部门的数据
            distribution_data = [
                {"department": "研发部", "critical": 20, "high": 40, "medium": 25, "low": 15},
                {"department": "运维部", "critical": 35, "high": 30, "medium": 20, "low": 15},
                {"department": "市场部", "critical": 25, "high": 20, "medium": 30, "low": 25},
                {"department": "产品部", "critical": 50, "high": 25, "medium": 15, "low": 10},
                {"department": "测试部", "critical": 15, "high": 35, "medium": 30, "low": 20}
            ]
            
            return {"data": distribution_data}, 200
        except Exception as ex:
            logger.exception(ex)
            return {"error_message": str(ex)}, 500


class MockBatchOperateVulnerabilitiesView(Resource):
    """批量操作漏洞"""
    
    def post(self):
        try:
            data = json.loads(request.data)
            vulnerability_ids = data.get('vulnerabilityIds', [])
            operation = data.get('operation', '')
            
            processed_count = 0
            for vuln_id in vulnerability_ids:
                vulnerability = next((v for v in mock_vulnerabilities if v['id'] == vuln_id), None)
                if vulnerability:
                    # 根据操作类型更新状态
                    if operation == 'fix':
                        vulnerability['status'] = 'fixed'
                    elif operation == 'ignore':
                        vulnerability['status'] = 'ignored'
                    elif operation == 'inProgress':
                        vulnerability['status'] = 'inProgress'
                    processed_count += 1
            
            return {
                "success": True,
                "message": f"成功处理 {processed_count} 个漏洞",
                "data": {
                    "processedCount": processed_count,
                    "operation": operation
                }
            }, 200
        except Exception as ex:
            logger.exception(ex)
            return {"error_message": str(ex)}, 500


class MockExportVulnerabilityReportView(Resource):
    """导出漏洞报告"""
    
    def post(self):
        try:
            data = json.loads(request.data)
            # 这里只是模拟，实际应该生成文件并返回下载链接
            # 或者直接返回文件内容让前端处理
            
            return {
                "success": True,
                "message": "报告导出成功",
                "data": {
                    "downloadUrl": f"/api/vulnerabilities/export/{int(data.get('timestamp', 0))}.txt"
                }
            }, 200
        except Exception as ex:
            logger.exception(ex)
            return {"error_message": str(ex)}, 500

